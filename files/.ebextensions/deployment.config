packages:
  yum:
    # We need nfs-utils in order to mount EFS targets.
    nfs-utils: []
files:
  # This script mounts the EFS files system on an EC2 instance. It is invoked in the "commands" section below.
  "/tmp/mount-efs.sh":
    mode: "000755"
    owner: root
    root: root
    content: |
      #!/bin/bash
      chmod 775 /mnt/efs
      mount -t nfs4 -o nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2 fs-696402a0.efs.eu-west-1.amazonaws.com:/ /mnt/efs
      ip route replace 69.162.69.144/29 via 10.11.5.19 dev eth0
      ip route replace 91.239.188.0/23 via 10.11.5.19 dev eth0
      mkdir -p /mnt/efs/data
      mkdir -p /mnt/efs/etc/kubernetes
commands:
  # Create a directory to which the EFS will be mouned, only if it does not already exist.
  010-make-mount-point:
    command: "mkdir /mnt/efs"
    test: "[ ! -d /mnt/efs ]"
  # Execute the script to mount the EFS, if it isn't already mounted (i.e. listed in /proc/mounts).
  020-mount-efs:
    command: "/tmp/mount-efs.sh"
    test: "! grep -qs '/mnt/efs ' /proc/mounts"